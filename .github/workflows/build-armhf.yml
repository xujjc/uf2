name: Build Canon ARMHF Driver

on:
  workflow_dispatch:
  push:
    branches: [main, master]

jobs:
  cross-compile:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout source
      uses: actions/checkout@v4
      with:
        repository: random3231/cndrvcups-lb
        path: cndrvcups-lb
        
    - name: Setup cross-compilation environment
      run: |
        # 添加多架构支持
        sudo dpkg --add-architecture armhf
        
        # 清理现有源配置
        sudo rm -f /etc/apt/sources.list /etc/apt/sources.list.d/*
        
        # 为 amd64 主机设置源 (仅主机依赖)
        echo "deb [arch=amd64] http://deb.debian.org/debian bookworm main" | sudo tee /etc/apt/sources.list
        echo "deb [arch=amd64] http://deb.debian.org/debian bookworm-updates main" | sudo tee -a /etc/apt/sources.list
        echo "deb [arch=amd64] http://security.debian.org/debian-security bookworm-security main" | sudo tee -a /etc/apt/sources.list
        
        # 为 armhf 交叉编译设置专用源
        echo "deb [arch=armhf] http://deb.debian.org/debian bookworm main" | sudo tee /etc/apt/sources.list.d/armhf.list
        echo "deb [arch=armhf] http://deb.debian.org/debian bookworm-updates main" | sudo tee -a /etc/apt/sources.list.d/armhf.list
        echo "deb [arch=armhf] http://security.debian.org/debian-security bookworm-security main" | sudo tee -a /etc/apt/sources.list.d/armhf.list
        
        # 安装 Debian 密钥环
        sudo apt-get update
        sudo apt-get install -y debian-archive-keyring
        
        # 添加所有必要的 GPG 密钥
        for KEY in 0E98404D386FA1D9 6ED0E7B82643E131 F8D2585B8783D481 54404762BBB6E853 BDE6D2B9216EC7A8; do
          sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys "$KEY" || \
          sudo apt-key adv --keyserver hkp://pgp.mit.edu:80 --recv-keys "$KEY"
        done
        
        # 更新软件源
        sudo apt-get update
        
        # 安装交叉编译工具链
        sudo apt-get install -y \
          crossbuild-essential-armhf \
          binutils-arm-linux-gnueabihf \
          gcc-arm-linux-gnueabihf \
          g++-arm-linux-gnueabihf
        
        # 安装 ARMHF 依赖库
        sudo apt-get install -y \
          libcups2-dev:armhf \
          libxml2-dev:armhf \
          libglib2.0-dev:armhf \
          libtiff-dev:armhf \
          libpng-dev:armhf \
          libjpeg-dev:armhf \
          libusb-1.0-0-dev:armhf
        
    - name: Configure build
      working-directory: cndrvcups-lb
      env:
        CC: arm-linux-gnueabihf-gcc
        CXX: arm-linux-gnueabihf-g++
        AR: arm-linux-gnueabihf-ar
        RANLIB: arm-linux-gnueabihf-ranlib
        CFLAGS: "-O2 -march=armv7-a -mfpu=neon-vfpv4 -mfloat-abi=hard"
        CXXFLAGS: "-O2 -march=armv7-a -mfpu=neon-vfpv4 -mfloat-abi=hard"
        LDFLAGS: "-Wl,--no-as-needed"
      run: |
        # 自动生成配置脚本
        if [ -f autogen.sh ]; then
          ./autogen.sh
        elif [ -f configure.ac ]; then
          autoreconf -vif
        fi
        
        # 配置编译选项
        ./configure \
          --host=arm-linux-gnueabihf \
          --prefix=/usr \
          --libdir=/usr/lib/arm-linux-gnueabihf \
          --enable-progpath=/usr/bin \
          --disable-static \
          --enable-shared
        
    - name: Compile driver
      working-directory: cndrvcups-lb
      run: |
        # 编译并验证
        make -j$(nproc)
        file cndrvcups-* | grep "ARM"
        
    - name: Package artifacts
      run: |
        # 创建输出目录
        mkdir -p output/{DEBIAN,usr/lib,etc/udev/rules.d}
        
        # 安装到临时目录
        cd cndrvcups-lb
        make install DESTDIR=$(pwd)/../output
        
        # 添加控制文件
        cat << 'EOF' > ../output/DEBIAN/control
        Package: cndrvcups-lb
        Version: 1.0-$(date +%Y%m%d)
        Architecture: armhf
        Maintainer: GitHub Actions
        Description: Canon Printer Driver for ARMv7
        Depends: libcups2, libxml2, libglib2.0-0, libtiff5, libpng16-16, libjpeg62-turbo, libusb-1.0-0
        EOF
        
        # 添加udev规则
        echo 'ATTRS{idVendor}=="04a9", MODE="0666", GROUP="lp"' > ../output/etc/udev/rules.d/80-canon.rules
        
        # 创建安装后脚本
        cat << 'EOF' > ../output/DEBIAN/postinst
        #!/bin/bash
        set -e
        [ "$1" = "configure" ] || exit 0
        ldconfig
        udevadm control --reload-rules
        udevadm trigger
        systemctl restart cups
        EOF
        chmod 755 ../output/DEBIAN/postinst
        
        # 构建DEB包
        cd ../output
        dpkg-deb --build . ../canon-driver-armhf.deb
        
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: canon-driver-armhf
        path: canon-driver-armhf.deb
